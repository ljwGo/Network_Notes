[toc]

# 网络层服务

1. ## 网络层基本服务

   > 网络层实现分组从**源主机**发送到**目的主机**

2. ## 路由表，交换结构转发

   > 如果说传输层是类似**传达室**的存在，那么为传输层提供服务的网络层就类似于**分拣中心**，由分拣中心决定包裹**到达目的地的路径**。

   ![路由表](D:\Notes\计算机网络\网络层\2021-11-15_200804.png)

   > 路由器有着多个不用类型的接入端口和输出端口。
   >
   > 比如有的使用*电话拨号上网*，*光纤上网*。
   >
   > 信号不同，接口的物理类型，以及支持的协议也自然不同。

   ![输入与输出端口](D:\Notes\计算机网络\网络层\2021-11-15_201228.png)

   

   **路由表**

   > 路由表记录着通路信息，表示该输出端口前往哪个子网；路由表中的路径信息应该是动态变化的

   **交换结构**

   > 实现数据转发的物理载体

   ![交换结构](D:\Notes\计算机网络\网络层\2021-11-15_201249.png)

# 网络层的实现类型

1. ## 数据报网络

   > 数据报型的网络是**无连接的**，**不可靠的**，同一源主机发送的分组，选择的网络层**路径可能不同**，会造成分组**乱序和丢失**
   >
   > 优点是**效率高**

2. ## 虚电路网络

   > 虚电路网络在发送数据前，需要在网络层建立一条**逻辑连接**，后续源主机发送的分组**都通过该连接**发送给目的主机，
   >
   > 虚电路网络本质还是**采用分组交换**技术，**与电路网络不同**的是，它**不独享该连接**，
   >
   > 其它用户仍能够使用该连接上的任意链路发送数据。
   >
   > 虚电路网络是**有连接的**，**比较可靠的**，也为此需要连接上的**网络节点为分组分配缓存**

# 网络拥塞控制

![网络拥塞](D:\Notes\计算机网络\网络层\2021-11-15_201420.png)



![流量感知路由](D:\Notes\计算机网络\网络层\2021-11-15_201508.png)

1. ## 源点抑制和背压

   当网络发生拥塞时

   > 源点抑制：
   >
   > ​	由发生拥堵的网络节点往返，告知发送分组的**源主机降低发送分组的速度**，以减缓网络拥堵
   >
   > 背压：
   >
   > ​	由发生拥堵的网络节点往返，告知路径上的所有**其它节点和源主机**降低发送分组的速度

2. ## 准入控制

   > 对需要建立的虚电路网络进行审核，如果数据不重要并且当前连接出现拥堵时，拒绝建立连接

3. ## 负载脱落

   > 丢包
   >
   > 丢弃新的包：如GBN
   >
   > 丢弃老的包：如实时视频流

# 异构网络

1. ## 异构网络

   > 异构网络，就是实现**支持不同协议的网络**的互联

2. ## 解决异构网络互联方式

   ![异构网络](D:\Notes\计算机网络\网络层\2021-11-15_201127.png)

   *协议转换*

   > 将网络1中不能被网络2识别的协议1
   >
   > 转换为可以被识别的协议2格式

   *虚拟网络协议*

   > 构建一种上层协议，该协议被其它所有网络支持
   >
   > 并且该协议能转换为各个不同下层协议

# 异构网络互连——IP协议

1. ## IP数据报格式

   ![IP数据报格式](D:\Notes\计算机网络\网络层\2021-11-15_201947.png)

   > *版本* ：IVP4和IVP6
   >
   > *首部长度* ：首部长度
   >
   > *区分服务*‘ ：为解决服务质量问题在网络上将用户发送的数据流按照它对服务质量的要求划分等级的一种协议
   >
   > *总长度* ：数据报头部和数据主体部分的总长度
   >
   > *标识* ：IP数据报是否被分片
   >
   > *标志* ：该分片是否是最后一个
   >
   > *片偏移* ：确定不同分片的先后顺序
   >
   > *生存时间* ：IP包可能在多个路由器中循环发送，无法到达目的地。设置生存时间，''过时''失效
   >
   > *协议* ：可以是传输层协议，也可以指内网网络层协议
   >
   > *首部效验和* ：不可靠的，不需要对数据主体部分进行效验
   >
   > *源IP*： 源IP
   >
   > *目的IP* ：目的IP

   

2. ## IVP4分类（了解即可，分类已经弃用）

   ![IVP4分类](D:\Notes\计算机网络\网络层\2021-11-15_202015.png)

   **网段**

   > IP地址后部分全为0

   **广播地址和直接广播地址**

   > IP地址后部分全为1

   

3. ## IVP4子网划分

   **子网划分的意义**

   > 子网划分类似于省市县的划分
   >
   > 要找我的家乡阳山县，知道先找到大的省份——广东省
   >
   > 再找小的市——清远市
   >
   > 最后找最小的县——阳山县
   >
   > 子网划分，可以让IP查找通过树的层级方式实现

   

   **子网划分的方法**

   > **子网地址**通过**子网掩码**与具体的IP地址执行**按位于**操作获得

   

   **子网掩码**

   > 由**连续的1和连续的0**组成
   >
   > 通常写法：
   >
   > ​	IP地址/子网掩码1的位数
   >
   > ​	比如——127.25.13.14/24，该IP所属子网地址为127.25.13.0

   
   
   又比如下图：
   
   > 在路由没有聚合前，15.65.154.130与26位的子网掩码按位与得到**子网地址**<u>15.65.154.128</u>，**与路由表第三条匹配**，
   >
   > 分组会转交给下一个IP地址为15.65.153.1的路由器，通过S1输出接口
   >
   > **注意：**
   >
   > ​	**网络地址也需要和子网掩码进行按位与操作**
   
   ![路由匹配](D:\Notes\计算机网络\网络层\2021-11-15_202130.png)

# 路由协议和路由算法

1. ## 路由算法

   **Dijkstra算法**

   ![Dj算法](D:\Notes\计算机网络\网络层\2021-11-15_202434.png)

   **自己的一些思考**

   > 一开始我从**动态规划问题**的角度尝试解这个算法
   >
   > 开始找**递推式**:thinking:
   >
   > 得到这样一个忽略很多特殊情况的递推式，设起点为**A**，另一节点为**X**
   >
   > A到达X的最短距离 = min{
   >
   > ​	**A**到达**X的某一相邻点X1**的**最短距离** + XX1的距离，
   >
   > ​	**A**到达**X的某一相邻点X2**的**最短距离** + XX2的距离，
   >
   > ​	**A**到达**X的某一相邻点X3**的**最短距离** + XX3的距离，
   >
   > ​	...
   >
   > }
   >
   > 出现了**最优解**由**最优子问题**组成的情况
   >
   > 但接下来不知道怎么继续了:disappointed:
   >
   > 老实记结论吧

   **再次回顾发现一些规律**

   > 寻找最新的*最近*节点,
   >
   > 是在已有的节点中,寻找直接连接的节点
   >
   > 只有跟现有节点直接连接的节点才可能是下一个最短路径的节点

   

   **距离向量算法**

   ![距离向量算法](D:\Notes\计算机网络\网络层\2021-11-15_202514.png)

   **自己的一些思考**

   > 实践发现，当**某一行的数据发生更新**，需要**重新计算这一行和这一列**，直到向量表不再发生改变
   >
   > 这可能不是算法最好的实现(某些情况下, 可能一个数值改变不会影响其他值, 这个我没有验证)

   

2. ## 网络层层次化划分

   ![网络层层次划分](D:\Notes\计算机网络\网络层\2021-11-15_202600.png)

   

3. ## 路由协议

   ![路由协议](D:\Notes\计算机网络\网络层\2021-11-15_202637.png)
   
   > RIP通常用于小网络
   >
   > OSPF通常用于大网络
   
   视频中就廖廖的介绍了一点, 有空在深入吧

# DOCP动态IP分配服务

![DOCP动态IP分配服务](D:\Notes\计算机网络\网络层\2021-11-15_202159.png)

> IP是动态的, 可以自己设置, 只要符合一些协议就能够在网络上被识别,
>
> 但不排除IP冲突(两个同样的内网IP)
>
> DHCP服务不要想复杂, 就是一个服务器(可能有某个端口被登记专门用于DHCP服务)
>
> DHCP服务器可能是维护了一个 映射表 记录已经分发的IP地址和对应的MAC地址, 这样就不会冲突了
>
> 公网IP应该有什么身份识别的协议(不然我就能改自己的IP为公网的了), 有机会的话去了解吧

# NAT内网IP转换协议

![NAT内网IP转换协议](D:\Notes\计算机网络\网络层\2021-11-15_202232.png)

NAT转换协议很重要, 这里做补充

[【硬核】公网访问？内网穿透！零经验上手！_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1Qq4y1w7F5?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click)

> 背景: IPV4地址已经分配完毕, 但入网设备却还在增长
>
> **解决1**: 抽离一区间的IPV4地址,重复使用
>
> ​	网段192.0.0.0 172.0.0.0 和 10.0.0.0被抽离出来, 重复使用, 称为内网IP
>
> ​	现在新入网的设备拥有了内网IP
>
> **问题:**由于内网IP是重复的, 全世界中一个内网IP可能对应多个设备, 我要访问192.8.8.8可能访问到很多设备
>
> ​	背离IP的设计--IP能够标识世界上唯一一台计算机
>
> **解决2**:划分公网和外网(就像全世界的小区都是独一无二的, 但小区里面的房间号却可以是相同的)
>
> ![](D:\Notes\计算机网络\网络层\2022-03-08_163742.png)
>
> 现在每个内网都有一个192.2.3.3的内网地址, 但它们彼此隔离, 所以不会冲突
>
> 但要保证, 同一个内网中不要出现相同的内网IP, 否则一样会冲突
>
> **问题:** 内网的设备能直接能够访问内网中其他设备(IP地址唯一), 但怎么访问公网
>
> **解决3:** NAT转换协议和公网网关
>
> ​	要想访问公网, 就必须使用公网IP
>
> ​	每个内网总会有一个**公网网关**, 它具有公网IP
>
> ​	网关会将内网设备的源IP换成自己的公网IP, 替你转发
>
> ![](D:\Notes\计算机网络\网络层\2022-03-08_164906.png)
>
> **问题:**内网设备能够访问其它内网吗?
>
> **解决:**(1)在公网网关中设置固定的端口映射(这部分就有机会补充和实践吧)
>
> ​		 (2)利用中转服务器内网穿透
>
> ​		 (3)zerotier-oneP2P模式的内网穿透
>
> 我是使用zerotier-one实现的内网穿透, 至于其使用教程, 参考网上的内容吧, 很简单
>
> **zerotier-oneP2P原理猜想**
>
> ​	两个不同内网的设备都需要安装zerotier-one的客户端
>
> ​	(1)连入zerotier-one虚拟局域网的设备,先和预置的服务端(built peer)进行通信, 也许内置服务器内置了一个表
>
> ​		该表将zerotier-one局域网提供的局域ip和设备的公网ip进行绑定
>
> ​	(2)内网设备A和另外内网设备B进行通信, 将设备B的zerotier-one局域网ip交给预置服务器
>
> ​		预置服务器将设备B的公网ip交给内网设备A
>
> ​	(3)设备A已经得到了设备B的公网ip地址
>
> ![](D:\Notes\计算机网络\网络层\2022-03-08_205924.png)
>
> ​	之后彼此就能够通讯了, 不过这样有个问题
>
> ​	就是通讯只能进行一次, 要进行下一次通讯, 必须等对方发送数据过来
>
> ​	**这个是自己的理解, 可能不对**



# 错误信息回执ICMP

![错误信息回执ICMP](D:\Notes\计算机网络\网络层\2021-11-15_202341.png)
